--Họ và tên: Vương Đinh Thanh Ngân 
--Lớp: IT004.ATCL.1
--Bài thực hành 1

CREATE DATABASE uit_qlgv

use uit_qlgv

--Câu 1: Tạo quan hệ và khai báo tất cả các ràng buộc khóa chính, khóa ngoại. Thêm vào 3 thuộc tính 
--GHICHU, DIEMTB, XEPLOAI cho quan hệ HOCVIEN.

CREATE TABLE KHOA(
	MAKHOA varchar(4),
	TENKHOA nvarchar(40),
	NGTLAP smalldatetime,
	TRGKHOA char(4),
	primary key (MAKHOA) --khoá chính
	)
CREATE TABLE MONHOC(
	MAMH varchar(10),
	TENMH nvarchar(40),
	TCLT tinyint,
	TCTH tinyint,
	MAKHOA varchar(4),
	primary key (MAMH)  --khoá chính
	)
CREATE TABLE DIEUKIEN(
	MAMH varchar(10), --thuộc tính khóa
	MAMH_TRUOC varchar(10), --thuộc tính khóa
	)
CREATE TABLE GIAOVIEN(
	MAGV char(4),
	HOTEN char(40),
	HOCVI varchar(10),
	HOCHAM varchar(10),
	GIOITINH varchar(3),
	NGAYSINH smalldatetime,
	NGVL smalldatetime,
	HESO numeric(4,2),
	MUCLUONG money,
	MAKHOA varchar(4),
	primary key (MAGV)  --khoá chính
	)
CREATE TABLE LOP(
	MALOP char(3),
	TENLOP nvarchar(40),
	TRGLOP char(5),
	SISO tinyint,
	MAGVCN char(4),
	primary key (MALOP)  --khoá chính
	)

CREATE TABLE HOCVIEN(
	MAHV char(5),
	HO nvarchar(40),
	TEN nvarchar(10),
	NGSINH smalldatetime,
	GIOITINH varchar(3),
	NOISINH nvarchar(40),
	MALOP char(3),
	primary key (MAHV)  --khoá chính
	)

CREATE TABLE GIANGDAY(
	MALOP char(3), --thuộc tính khóa
	MAMH varchar(10), --thuộc tính khóa
	MAGV char(4),
	HOCKY tinyint,
	NAM smallint,
	TUNGAY smalldatetime,
	DENNGAY smalldatetime,
	)
CREATE TABLE KETQUATHI(
	MAHV char(5), --thuộc tính khóa
	MAMH varchar(10), --thuộc tính khóa
	LANTHI tinyint, --thuộc tính khóa
	NGATHI smalldatetime,
	DIEM numeric(4,2),
	KQUA varchar(10),
	)

ALTER TABLE KHOA
ADD constraint FK_KHOA_TRGKHOA foreign key (TRGKHOA) references GIAOVIEN(MAGV)

ALTER TABLE MONHOC
ADD CONSTRAINT FK_MONHOC_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE DIEUKIEN
ADD CONSTRAINT FK_DIEUKIEN_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE DIEUKIEN
ADD CONSTRAINT FK_DIEUKIEN_MAMH_TRUOC FOREIGN KEY(MAMH_TRUOC) REFERENCES MONHOC(MAMH)

ALTER TABLE GIAOVIEN
ADD CONSTRAINT FK_GIAOVIEN_KHOA FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE LOP
ADD CONSTRAINT FK_LOP_TRGLOP FOREIGN KEY (TRGLOP) REFERENCES HOCVIEN (MAHV)

ALTER TABLE LOP
ADD CONSTRAINT FK_LOP_GVCN FOREIGN KEY (MAGVCN) REFERENCES GIAOVIEN (MAGV)

ALTER TABLE HOCVIEN
ADD CONSTRAINT FK_HOCVIEN_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE GIANGDAY
ADD CONSTRAINT FK_GIANGDAY_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE GIANGDAY
ADD CONSTRAINT FK_GIANGDAY_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE KETQUATHI
ADD CONSTRAINT FK_KETQUATHI_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE KETQUATHI
ADD CONSTRAINT FK_KETQUATHI_HOCVIEN FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV)

-- Thêm vào 3 thuộc tính GHICHU, DIEMTB,XEPLOAI cho quan hệ HOCVIEN
ALTER TABLE HOCVIEN
ADD GHICHU nvarchar(50)

ALTER TABLE HOCVIEN
ADD DIEMTB numeric(4,2)

ALTER TABLE HOCVIEN
ADD XEPLOAI varchar(10)

--Câu 2:Mã học viên là một chuỗi 5 ký tự, 3 ký tự đầu là mã lớp, 2 ký tự cuối cùng là số thứ tự học viên trong lớp. VD: “K1101”

ALTER TABLE HOCVIEN
ADD CONSTRAINT CHK_MAHV CHECK(SUBSTRING(MAHV, 1, 3) = MALOP AND ISNUMERIC( SUBSTRING(MAHV, 4, 2))= 1)

--Câu 3: Thuộc tính GIOITINH chỉ có giá trị là “Nam” hoặc “Nu”.

ALTER TABLE GIAOVIEN
ADD CONSTRAINT CHK_GIOITINHGIAOVIEN CHECK(GIOITINH IN('NAM' , 'NU', 'NONE'))

ALTER TABLE HOCVIEN 
ADD CONSTRAINT CHK_GIOITINHHOCVIEN CHECK(GIOITINH IN ('NAM', 'NU', 'NONE'))

--Câu 4: Điểm số của một lần thi có giá trị từ 0 đến 10 và làm tròn 2 chữ thập phân
ALTER TABLE KETQUATHI
ADD CONSTRAINT CHK_DIEM CHECK((DIEM between 0 and 10 ) and DIEM = round(diem,2))

--Nhâp dữ liệu--

SET DATEFORMAT DMY
use uit_qlgv
--Khoa--
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('KHMT', N'KHOA HỌC MÁY TÍNH', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('HTTT', N'HỆ THỐNG THÔNG TIN', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('MTT', N'MẠNG VÀ TRUYỀN THÔNG', '20/10/2010')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('CNPM', N'CÔNG NGHỆ PHẦN MỀM', '7/6/2005')
INSERT INTO KHOA (MAKHOA, TENKHOA, NGTLAP) VALUES ('KTMT', N'KỸ THUẬT MÁY TÍNH', '20/12/2005')

--GIAOVIEN--
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV01', 'HO THANH SON' , 'PTS', 'GS', 'NAM', '2/5/1950', '1/11/2004', 5.00, 2250000, 'KHMT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV02', 'TRAN TAM THANH', 'TS', 'PGS', 'NAM', '17/12/1965', '20/4/2004', 4.50, 2025000, 'HTTT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV03', 'DO NGHIEM PHUNG', 'TS', 'GS', 'NU', '1/8/1950', '23.9.2004', 4.00, 1800000, 'CNPM')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV04', 'TRAN NAM SON', 'TS', 'PGS', 'NAM', '22/2/1961', '12/01.2005', 4.50, 2050000, 'KTMT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV05', 'MAI THANH DANH', 'THS', 'GV', 'NAM', '12/3/1958', '12/1/2005', 3.00, 135000, 'HTTT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV06', 'TRAN DOAN HUNG', 'TS', 'GV', 'NAM', '12/3/1953', '12/1/2005', 4/50, 205000, 'KHMT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV07', 'NGUYEN MINH TIEN', 'THS', 'GV', 'NAM', '23/1/1971', '1/3/2005', 4.00, 1800000,'KHMT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV08', 'LE THI TRAN', 'KS', 'NULL', 'NU', '26/3/1974', '1/3/2005', 1.69, 760500, 'KHMT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV09', 'NGUYEN TO LAN', 'THS', 'GV', 'NU', '31/12/1966', '1/3/2005', 4.00, 1800000,'HTTT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV10', 'LE TRAN ANH LOAN', 'KS', 'NULL', 'NU', '17/7/1972', '1/3/2005', 1.66, 837000, 'CNPM')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV11', 'HO THANH TUNG', 'CN', 'NULL', 'NAM', '12/1/1980', '15/5/2005', 2.67, 120100,'MTT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV12', 'TRAN VAN ANH', 'CN', 'NULL', 'NU', '29/3/1981', '15/5/2005', 1.69, 760000, 'CNPM')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV13', 'NGUYEN LINH DAN', 'CN', 'NULL', 'NU', '23/5/1980', '15/5/2005', 1.69, 760000, 'KTMT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV14', 'TRUONG MINH CHAU', 'THS', 'GV', 'NU', '30/11/1976', '15.5.2005', 3.00, 1350000, 'MTT')
INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGAYSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES ('GV15', 'LE HA THANH', 'THS', 'GV', 'NAM', '4/5/1978', '15/5/2005',  3.00, 1350000,'KHMT')

UPDATE KHOA SET TRGKHOA = 'GV01' WHERE MAKHOA = 'KHMT'
UPDATE KHOA SET TRGKHOA = 'GV02' WHERE MAKHOA = 'HTTT'
UPDATE KHOA SET TRGKHOA = 'GV04' WHERE MAKHOA = 'CNPM'
UPDATE KHOA SET TRGKHOA = 'GV03' WHERE MAKHOA = 'MTT'

SET DATEFORMAT DMY
--MONHOC--
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('THDC', N'TIN HỌC ĐẠI CƯƠNG', '4', '1', 'KHMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('CTRR', N'CẤU TRÚC RỜI RẠC', '5', '0', 'KHMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('CSDL', N'CƠ SỞ DỮ LIỆU', '3', '1', 'HTTT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('CTDLGT', N'CẤU TRÚC DỮ LIỆU VÀ GIẢI THUẬT', '3', '1','KHMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('PTTKTT', N'PHÂN TÍCH THIẾT KẾ THUẬT TOÁN', '3', '0', 'KHMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('DHMT', N'ĐỒ HOẠ MÁY TÍNH', '3', '1', 'KHMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('KTMT', N'KIẾN TRÚC MÁY TÍNH', '3','0','KTMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('TKCSDL' , N'THIẾT KẾ CƠ SỞ DỮ LIỆU', '3', '1', 'HTTT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('PTTKHTTT', 'PHÂN TÍCH THIẾT KẾ HỆ THỐNG THÔNG TIN', '4', '1', 'HTTT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('HDH', N'HỆ ĐIỀU HÀNH', '4', '0','KTMT')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('NMCNPM', N'NHẬP MÔN CÔNG NGHỆ PHẦN MỀM', '3', '0', 'CNPM')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('LTCFW', N'LẬP TRÌNH C FOR WIN', '3','1', 'CNPM')
INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES ('LTHDT', N'LẬP TRÌNH HƯỚNG ĐỐI TƯỢNG','3', '1', 'CNPM')

SET DATEFORMAT DMY
--Lop--
INSERT INTO LOP (MALOP, TENLOP, SISO, MAGVCN) VALUES ('K11', N'LỚP 1 KHOA 1', '11', 'GV07')
INSERT INTO LOP (MALOP, TENLOP, SISO, MAGVCN) VALUES ('K12', N'LỚP 2 KHOÁ 1', '12', 'GV09')
INSERT INTO LOP (MALOP, TENLOP, SISO, MAGVCN) VALUES ('K13', N'LỚP 3 KHOÁ 1', '12', 'GV09')

SET DATEFORMAT DMY
--HOCVIEN--
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1101', N'Nguyễn Văn', N'A', '27/1/1986','NAM',N'TpHCM', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1102', N'Trần Ngọc', N'Hân', '14/3/1986','NU',N'Kiên Giang', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1103', N'Hà Duy', N'Lập', '18/4/1986','NAM',N'Nghe An', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1104', N'Trần Ngọc', N'Linh', '30/3/1986','NU',N'Tay Ninh', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1105', N'Trần Minh', N'Long', '27/2/1986','NAM',N'TpHCM', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1106', N'Lê Nhật', N'Minh', '24/1/1986','NAM',N'TpHCM', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1107', N'Nguyễn Như', N'Nhựt', '27/1/1986','NAM',N'Hà Nội', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1108', N'Nguyễn Mạnh', N'Tâm', '27/2/1986','NAM',N'Kiên Giang', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1109', N'Phan Thị Thanh', N'Tâm', '27/1/1986','NU',N'Vĩnh Long', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1110', N'Lê Hoài', N'Thương', '5/2/1986','NU',N'Cần Thơ', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1111', N'Lê Hà', N'Vinh', '25/12/1986','NAM',N'Vĩnh Long', 'K11')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1201', N'Nguyễn Văn', N'B', '11/2/1986','NAM',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1202', N'Nguyễn Thị Kim', N'Duyên', '17/9/1986','NU',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1203', N'Trần Thị Kim', N'Duyên', '17/9/1986','NU',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1204', N'Trương Mỹ', N'Hạnh', '19/5/1986','NU',N'Đồng Nai', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1205', N'Nguyễn Thành', N'Nam', '17/4/1986','NAM',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1206', N'Nguyễn Thị Trúc', N'Thanh', '4/3/1986','NU',N'Kiên Giang', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1207', N'Trần Thị Bích', N'Thủy', '8/2/1986','NU',N'Nghệ An', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1208', N'Huỳnh Thị Kim', N'Triều', '8/4/1986','NU',N'Tây Ninh', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1209', N'Phạm Thanh', N'Triều', '23/2/1986','NAM',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1210', N'Ngô Thanh', N'Tuấn', '14/2/1986','NAM',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1211', N'Đỗ Thị', N'Xuân', '9/3/1986','NU',N'Hà Nội', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1212', N'Lê Thị Phi', N'YẾn', '12/3/1986','NU',N'TpHCM', 'K12')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1301', N'Nguyễn Thị Kim', N'Cúc', '9/6/1986','NU',N'Kiên Giang', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1302', N'Trương Thị Mỹ', N'Hiền', '18/3/1986','NU',N'Nghệ An', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1303', N'Lê Đức', N'Hiển', '21/3/1986','NAM',N'Tây Ninh', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1304', N'Lê Quang', N'Hiển', '18/4/1986','NAM',N'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1305', N'Lê Thị', N'Hương', '27/3/1986','NU',N'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1306', N'Nguyễn Thái', N'Hữu', '30/3/1986','NAM',N'Hà Nội', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1307', N'Trần Minh', N'Mẫn', '28/5/1986','NAM',N'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1308', N'Nguyễn Hữu', N'Nghĩa', '8/4/1986','NAM',N'Kiên Giang', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1309', N'Nguyễn Trung', N'Nghĩa', '18/1/1986','NAM',N'Nghệ An', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1310', N'Trần Thị Hồng', N'Thắm', '22/4/1986','NU',N'Tây Ninh', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1311', N'Trần Minh', N'Thục', '4/4/1986','NAM',N'TpHCM', 'K13')
INSERT INTO HOCVIEN(MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES('K1312', N'Nguyễn Thị Kim', N'Yến', '7/9/1986','NU',N'TpHCM', 'K13')

UPDATE LOP SET TRGLOP = 'K1108' WHERE MALOP = 'K11'
UPDATE LOP SET TRGLOP = 'K1205' WHERE MALOP = 'K12'
UPDATE LOP SET TRGLOP = 'K1305' WHERE MALOP = 'K13'

SET DATEFORMAT DMY
--ĐIEUKIEN--
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('CSDL', 'CTRR')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('CSDL', 'CTDLGT')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('CTDLGT', 'THDC')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('PTTKTT', 'THDC')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('PTTKTT', 'CTDLGT')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('DHMT', 'THDC')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('LTHDT', 'THDC')
INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES ('PTTKHTTTT', 'CSDL')

SET DATEFORMAT DMY
--GIANGDAY--
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K11', 'THDC', 'GV07', 1, 2006, '2/1/2006', '12/5/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K12', 'THDC', 'GV06', 1, 2006, '2/2/2006', '12/5/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K13', 'THDC', 'GV15', 1, 2006, '2/1/2006', '12/5/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K11', 'CTRR', 'GV02', 1, 2006, '9/1/2006', '17/5/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K12', 'CTRR', 'GV02', 1, 2006, '9/1/2006', '17/5/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K13', 'CTRR', 'GV08', 1, 2006, '1/6/2006', '15/7/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K11', 'CSDL', 'GV05', 2, 2006, '1/6/2006', '15/7/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K12', 'CSDL', 'GV09', 2, 2006, '1/6/2006', '15/7/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K13', 'CTDLGT', 'GV15', 2, 2006, '1/6/2006', '15/7/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K13', 'CSDL', 'GV05', 3, 2006, '1/8/2006', '15/12/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K13', 'DHMT', 'GV07', 3, 2006, '1/8/2006', '15/12/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K11', 'CTDLGT', 'GV15', 3, 2006, '1/8/2006', '15/12/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K12', 'CTDLGT', 'GV15', 3, 2006, '1/8/2006', '15/12/2006')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K11', 'HDH', 'GV04', 1, 2007, '2/1/2007', '20/3/2007')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K12', 'HDH', 'GV04', 1, 2007, '2/1/2007', '20/3/2007')
INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES ('K11', 'DHMT', 'GV07', 1, 2007, '18/2/2007', '20/3/2007')

SET DATEFORMAT DMY
--KETQUATHI--
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1101', 'CSDL', 1, '20/7/2006', 10.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1101', 'CTDLGT', 1, '28/12/2006', 9.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1101', 'THDC', 1, '20/5/2006', 9.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1101', 'CTRR', 1, '13/5/2006', 9.5, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CSDL', 1, '20/7/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CSDL', 2,  '27/7/2006', 4.2, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CSDL', 3, '10/8/2006', 4.50, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CTDLGT', 1, '28/12/2006', 4.50, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CTDLGT', 2, '5/2/2007', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CTDLGT', 3, '15/1/2007', 6.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'THDC', 1, '20/5/2006', 5.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1102', 'CTRR', 1, '13/5/2006', 7.00,'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1103', 'CSDL', 1, '20/7/2006', 3.50, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1103', 'CSDL', 2, '27/7/2006',8.25, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1103', 'CTDLGT', 1, '28/12/2006', 7.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1103', 'THDC', 1, '20/5/2006', 8.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1103', 'CTRR', 1, '13/5/2006', 6.50, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1104', 'CSDL', 1, '20/7/2006', 3.75, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1104', 'CTDLGT', 1, '28/12/2006', 4.60, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1104', 'THBC', 1, '20/5/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1104', 'CTRR', 1, '13/5/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1104', 'CTRR', 2, '20/5/2006', 3.50, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1104', 'CTRR', 3, '30/6/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1201', 'CSDL', 1, '20/7/2006', 6.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1201', 'CTDLGT', 1, '28/12/2006', 5.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1201', 'THDC', 1, '20/5/2006', 8.50, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1201', 'CTRR', 1, '13/5/2006', 9.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1201', 'CSDL', 1, '20/7/2006', 8.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'CTDLGT', 1, '20.5.2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'CTDLGT', 2, '5/1/2007', 5.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'THDC', 1, '20/5/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'THDC', 2, '27/5/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'CTRR', 1, '13/5/2006', 3.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'CTRR', 2, '20/5/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1202', 'CTRR', 3, '30/6/2006', 6.25, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1203', 'CSDL', 1, '20/7/2006', 9.25, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1203', 'CTDLGT', 1, '28/12/2006',9.50, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1203', 'THDC', 1, '20/5/2006', 10.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1203', 'CTRR', 1, '13/5/2006', 10.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1204', 'CSDL', 1, '20/7/2006', 8.50, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1204', 'CTDLGT', 1, '28/12/2006', 6.75, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1204', 'THDC', 1, '20/5/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1204', 'CTRR', 1, '13/5/2006', 6.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1301', 'CSDL', 1, '20/12/2006', 4.25, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1301', 'CTDLGT', 1, '25/7/2006', 8.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1302', 'THDC', 1, '20/5/2006', 6.75, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1301', 'CTRR', 1, '13/5/2006', 8.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1302', 'CSDL', 1, '20/12/2006', 6.75, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1302', 'CTDLGT', 1, '25/7/2006', 5.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1302', 'THDC', 1, '20/5/2006', 8.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1302', 'CTRR', 1, '13/5/2006', 8.50, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'CSDL', 1, '20/12/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'CTDLGT', 1, '25/7/2006', 4.50, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'CTDLGT', 2, '7/8/2006', 4.00, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'CTDLGT', 3, '15/8/2006', 4.25, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'THDC', 1, '20/5/2006', 4.50, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'CTRR', 1, '13/5/2006', 3.25, 'KHONG DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1303', 'CTRR', 3, '20/5/2006', 5.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1304', 'CSDL', 1, '20/12/2006', 7.75, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1304', 'CTDLGT', 1, '25/7/2006', 9.75, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1304', 'THDC', 1, '20/5/2006', 5.50, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1304', 'CTRR', 1, '13/5/2006', 5.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1305', 'CSDL', 1, '20/12/2006', 9.25, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1305', 'CTDLGT', 1, '25/7/2006', 10.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1305', 'THDC', 1, '20/5/2006', 8.00, 'DAT')
INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGATHI, DIEM, KQUA) VALUES ('K1305', 'CTRR', 1, '13/5/2006', 10.00, 'DAT')

-----------------------------------Buổi 2(13/10)---------------------------------
use uit_qlgv

update KHOA
set TRGKHOA = 'GV05'
WHERE( MAKHOA ='KHMT')

update KHOA
SET TRGKHOA = 'GV06'
WHERE( MAKHOA ='HTTT')

-- làm vài ví dụ tại bài học thực hành  trên lớp
SELECT *
FROM LOP

SELECT * 
FROM HOCVIEN

SELECT *
FROM HOCVIEN
WHERE MALOP='K12'

SELECT *
FROM HOCVIEN
WHERE NOISINH = 'TpHCM' or NOISINH = N'Hà Nội'

SELECT concat (HO, ' ' , TEN), GIOITINH, NGSINH
FROM HOCVIEN
WHERE NOISINH in ( 'HANOI')

------Phần II ----
-- Câu 1: Tăng hệ số lương thêm 0.2 cho những giáo viên là trưởng khoa 

SELECT * FROM KHOA

UPDATE GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (SELECT TRGKHOA FROM KHOA)

-- Câu 2: Cập nhật giá trị điểm trung bình tất cả các môn học (DIEMTB) của mỗi học viên (tất cả các môn học đều có hệ số 1 
--và nếu học viên thi một môn nhiều lần, chỉ lấy điểm của lần thi sau cùng)

SELECT * FROM HOCVIEN

UPDATE HOCVIEN
SET  DIEMTB = (SELECT AVG(DIEM) 
               FROM KETQUATHI THI
			   WHERE MAHV = HOCVIEN.MAHV
			   AND LANTHI =(SELECT MAX(LANTHI) FROM KETQUATHI thi
			   WHERE thi.MAMH = THI.MAMH AND thi.MAHV = THI.MAHV))

-- 3. Cập nhật giá trị cho cột GHICHU là "Cam thi" đối với trường hợp: học viên có một môn bất kỳ thi lần thứ 3 dưới 5 điểm

UPDATE HOCVIEN
SET GHICHU = 'CAM THI'
WHERE EXISTS (SELECT * FROM KETQUATHI 
              WHERE MAHV = HOCVIEN.MAHV AND LANTHI = 3 AND DIEM <5)

-- 4. Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN:
-- Nếu DIEMTB >= 9 thì XEPLOAI =”XS”
-- Nếu 8 <= DIEMTB < 9 thì XEPLOAI = “G”
-- Nếu 6.5 <= DIEMTB < 8 thì XEPLOAI = “K”
-- Nếu 5 <= DIEMTB < 6.5 thì XEPLOAI = “TB”
-- Nếu DIEMTB < 5 thì XEPLOAI = ”Y”  

UPDATE HOCVIEN
SET XEPLOAI = 'XS'
WHERE DIEMTB >= 9

UPDATE HOCVIEN
SET XEPLOAI = 'G'
WHERE DIEMTB >= 8 AND DIEMTB < 9

UPDATE HOCVIEN
SET XEPLOAI = 'K'
WHERE DIEMTB >= 6.5 AND DIEMTB < 8

UPDATE HOCVIEN
SET XEPLOAI = 'TB'
WHERE DIEMTB >= 5 AND DIEMTB < 6.5

UPDATE HOCVIEN
SET XEPLOAI = 'Y'
WHERE DIEMTB < 5

------PHẦN 3-----

-- CÂU 1: In ra danh sách (mã học viên, họ tên , ngày sinh, mã lớp) lớp trưởng của lớp 
--C1:

SELECT MAHV, concat(HO, ' ', TEN) AS HOTEN, NGSINH, HOCVIEN.MALOP
FROM HOCVIEN INNER JOIN LOP ON HOCVIEN.MAHV = LOP.TRGLOP

--C2:

SELECT MAHV, concat(HO, ' ', TEN) AS HOTEN, NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP


-- CÂU 2: In ra bảng điểm khi thi( mã học viên, họ tên, lần thi, điểm số) môn CTRR của lớp "K12:, sắp xếp theo tên, họ học viên--
-- C1:

SELECT HOCVIEN.MAHV, HO, TEN, LANTHI, DIEM
FROM KETQUATHI, HOCVIEN
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV
      AND MAMH = 'CTRR'
	  AND MALOP = 'K12'
ORDER BY TEN, HO
--C2:
SELECT *
FROM KETQUATHI
WHERE MAMH = 'CTRR'

SELECT *
FROM HOCVIEN
WHERE MALOP = 'K12'

SELECT HOCVIEN.MAHV, concat(HO, ' ', TEN) AS HOTEN, LANTHI, DIEM
FROM KETQUATHI, HOCVIEN
WHERE MAMH = 'CTRR' AND KETQUATHI.MAHV IN ( SELECT MAHV
									FROM HOCVIEN
									WHERE MALOP = 'K12')
ORDER BY TEN, HO

-- C3:

SELECT HOCVIEN.MAHV, concat(HO, ' ', TEN) AS HOTEN, LANTHI, DIEM
FROM KETQUATHI INNER JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE  MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY TEN, HO

-- CÂU 3: In ra danh sách những học viên( mã học viên, học tên) và những môn học mà học viên đó thi lần thứ nhất đã đạt
-- Cách 1:

SELECT HOCVIEN.MAHV, concat(HO, ' ', TEN) AS HOTEN, KETQUATHI.MAMH, TENMH
FROM KETQUATHI
INNER JOIN HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV
INNER JOIN MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH
WHERE LANTHI = 1 AND KQUA = N'DAT' 

-- Cách 2:

SELECT HOCVIEN.MAHV, concat(HO, ' ', TEN) AS HOTEN, TENMH
FROM KETQUATHI, MONHOC, HOCVIEN
WHERE KETQUATHI.MAMH = MONHOC.MAMH
	  AND KETQUATHI.MAHV = HOCVIEN.MAHV
	  AND LANTHI = 1 AND KQUA = N'DAT'
-- 4. In ra danh sách học viên của lớp "K11" thi môn CTRR không dạt (ở lần thi 1)---
-- C1
SELECT HOCVIEN.MAHV, concat(HO, ' ', TEN) AS HOTEN
FROM KETQUATHI INNER JOIN HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE MALOP = 'K11' AND MAMH = 'CTRR' AND LANTHI = 1 AND KQUA = N'KHONG DAT'


-- C2

SELECT HOCVIEN.MAHV, concat(HO, ' ', TEN) AS HOTEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
AND MALOP = 'K11'
AND MAMH = 'CTRR'
AND LANTHI = 1
AND KQUA = N'KHONG DAT' 

--------------------------------BUỔI 3---------------------------------
use uit_qlgv

--CÂU 5: Danh sách học viên (mã học viên, họ tên) của lớp “K” thi môn CTRR không đạt (ở tất cả
--các lần thi).
--CÁCH 1:
SELECT DISTINCT HOCVIEN.MAHV, concat(HO,' ', TEN) AS HOTEN 
FROM  KETQUATHI INNER JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV 
WHERE SUBSTRING(HOCVIEN.MALOP, 1, 1)  = 'K' AND MAMH = 'CTRR'
      AND KQUA = 'KHONG DAT'
	  AND HOCVIEN.MAHV NOT IN (SELECT MAHV		--xét sinh viên không đạt ngay ở lần đầu, các lần sau có đạt => không tính--
	                           FROM KETQUATHI 
							   WHERE MAMH = 'CTRR' AND KQUA = 'DAT'
							   AND LANTHI>= 2
							   )
--CÁCH 2: Làm bằng tập hợp--
SELECT DISTINCT HOCVIEN.MAHV, concat(HO,' ', TEN) AS HOTEN
FROM  HOCVIEN 
WHERE	  MAHV IN ( SELECT DISTINCT MAHV
					FROM KETQUATHI
					WHERE MAMH = 'CTRR' AND KQUA ='KHONG DAT' 
					EXCEPT
					SELECT DISTINCT MAMH
					FROM KETQUATHI
					WHERE MAMH = 'CTRR' AND KQUA ='DAT' AND LANTHI >= 2 
					) AND SUBSTRING(HOCVIEN.MALOP, 1, 1)  = 'K'

--CÂU 6: Tìm tên những môn học mà giáo viên có tên “Tran Tam Thanh” dạy trong học kỳ 1 năm 2006 --
SELECT *
FROM MONHOC 
			INNER JOIN GIANGDAY ON MONHOC.MAMH = GIANGDAY.MAMH
			INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = 'TRAN TAM THANH'
		AND HOCKY = 1 AND NAM = 2006

-- LÀM THÊM: Xuất ra thông tin các lớp trưởng mà giáo viên TRAN TAM THANH đã dạy--

SELECT DISTINCT HOCVIEN.MAHV,NGSINH, concat(HO,' ', TEN) AS LOPTRUONG
FROM HOCVIEN INNER JOIN LOP ON HOCVIEN.MAHV = LOP.TRGLOP
			INNER JOIN GIANGDAY ON LOP.MALOP = GIANGDAY.MALOP
			INNER JOIN MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH
			INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE  HOTEN = 'TRAN TAM THANH'
		AND HOCKY = 1 AND NAM = 2006

--- LÀM THÊM: Các lớp mà giáo viên TRAN THANH TAM đã dạy Cấu Trúc rời rạc--

SELECT *
FROM LOP
		INNER JOIN GIANGDAY ON LOP.MALOP = GIANGDAY.MALOP
		INNER JOIN MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH
		INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = 'TRAN TAM THANH'
	  AND TENMH = N'CẤU TRÚC RỜI RẠC'
	  AND HOCKY = 1 AND NAM = 2006


-- CÂU 7: Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy trong học kỳ 1 năm 2006--

SELECT MONHOC.MAMH,TENMH
FROM MONHOC
	INNER JOIN GIANGDAY ON MONHOC.MAMH = GIANGDAY.MAMH
	INNER JOIN LOP ON GIANGDAY.MALOP = LOP.MALOP
WHERE LOP.MAGVCN ='K11'

SELECT DISTINCT GIANGDAY.MAMH, TENMH
FROM GIANGDAY INNER JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
WHERE MAGV = ( SELECT MAGVCN 
				FROM LOP WHERE MALOP = 'K11')

--CÂU 8: Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So Du Lieu”--
--CÁCH 1:
SELECT HOCVIEN.MAHV, CONCAT(HO,' ', TEN) AS LOPTRUONG
FROM HOCVIEN
WHERE MAHV IN ( SELECT TRGLOP
				FROM LOP
				INNER JOIN GIANGDAY ON LOP.MALOP = GIANGDAY.MALOP
				INNER JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
				INNER JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
				WHERE HOTEN = 'NGUYEN TO LAN' AND TENMH = N'CƠ SỞ DỮ LIỆU'
				)
--CÁCH 2: (chỉ có thể lấy được mã học viên của lớp trưởng)
SELECT DISTINCT TRGLOP
FROM LOP
		INNER JOIN GIANGDAY ON LOP.MALOP = GIANGDAY.MALOP
		INNER JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
		INNER JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
WHERE HOTEN = 'NGUYEN TO LAN' AND TENMH = N'CƠ SỞ DỮ LIỆU'

--CÂU 9: In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So Du Lieu”.

SELECT MAMH, TENMH
FROM MONHOC
WHERE MAMH IN ( SELECT MAMH_TRUOC
				FROM DIEUKIEN 
				INNER JOIN MONHOC ON DIEUKIEN.MAMH = MONHOC.MAMH
				WHERE MONHOC.TENMH = N'CƠ SỞ DỮ LIỆU')

--CÂU 10: Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học, tên môn học) nào --

SELECT MAMH, TENMH
FROM MONHOC
WHERE MAMH IN ( SELECT DIEUKIEN.MAMH	--không ghi mỗi MAMH vì sẽ bị trung với tựa MAMH của MONHOC--
				FROM DIEUKIEN
				INNER JOIN MONHOC ON DIEUKIEN.MAMH_TRUOC = MONHOC.MAMH
				WHERE MONHOC.TENMH = N'CẤU TRÚC RỜI RẠC')
--CÂU 11: Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1 năm 2006 --

--CÁCH 1:
SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
WHERE MAGV IN ( SELECT MAGV FROM GIANGDAY
				WHERE MALOP = 'K11' AND MAMH = 'CTRR' AND HOCKY = 1 AND NAM = 2006
				UNION
				SELECT MAGV FROM GIANGDAY
				WHERE MALOP = 'K12' AND MAMH = 'CTRR' AND HOCKY = 1 AND NAM = 2006
				)

--CÁCH 2:
SELECT DISTINCT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
	INNER JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV
	INNER JOIN LOP ON GIANGDAY.MALOP = LOP.MALOP
WHERE LOP.MALOP IN ( 'K11', 'K12') AND MAMH = 'CTRR' --Và k11 với k12 dùng IN--
				AND HOCKY = 1 AND NAM = 2006

--CÂU 12: Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng
-- chưa thi lại môn này--

SELECT DISTINCT HOCVIEN.MAHV, concat(HO,' ',TEN)
FROM HOCVIEN
WHERE MAHV IN ( SELECT MAHV 
				FROM KETQUATHI
				WHERE MAMH = 'CSDL' AND LANTHI = 1 AND KQUA = 'KHONG DAT'
				EXCEPT 
				SELECT MAHV
				FROM KETQUATHI
				WHERE MAMH = 'CSDL' AND LANTHI > 1
				)

--CÂU 13: Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào--

SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
WHERE MAGV IN (SELECT GIAOVIEN.MAGV		--Trừ mã giáo viên với nha--
				FROM GIAOVIEN
				EXCEPT
				SELECT DISTINCT GIANGDAY.MAGV
				FROM GIANGDAY
				GIAOVIEN INNER JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV
				)

--CÂU 14: Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào
--thuộc khoa giáo viên đó phụ trách--

SELECT MaGV, HoTen
FROM GiaoVien
WHERE NOT EXISTS
(
	SELECT *
	FROM MonHoc
	WHERE MonHoc.MaKhoa = GiaoVien.MaKhoa
	AND NOT EXISTS
	(
		SELECT *
		FROM GiangDay
		WHERE GiangDay.MaMH = MonHoc.MaMH
		AND GiangDay.MaGV = GiaoVien.MaGV
	)
)

--CÂU 15: Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat”
--hoặc thi lần thứ 2 môn CTRR được 5 điểm --

SELECT CONCAT(HO,' ', TEN)
FROM HOCVIEN
WHERE MAHV IN (  SELECT MAHV		-- Điều kiện 1 --
				FROM KETQUATHI
				WHERE MALOP = 'K11' AND LANTHI >= 3 AND KQUA = 'KHONG DAT'
				UNION
				SELECT MAHV			-- Điều kiện 2 --
				FROM KETQUATHI 
				WHERE MALOP = 'K11' AND LANTHI = 2 AND MAMH = 'CTRR' AND DIEM = 5
			)

--CÂU 16: Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm học --

SELECT HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GiaoVien.MaGV = GiangDay.MaGV AND MaMH = 'CTRR'
GROUP BY GIAOVIEN.MAGV, HOTEN, HOCKY, NAM
HAVING COUNT(MALOP) >=2

--CÂU 17: Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng)--
SELECT DISTINCT
	HocVien.*, Diem AS DIEMCUOI
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND MaMH = 'CSDL'
	AND LanThi = 
	(
		SELECT MAX(LanThi) 
		FROM KetQuaThi 
		WHERE MaMH = 'CSDL' AND KetQuaThi.MaHV = HocVien.MaHV 
		GROUP BY MaHV
	)

-- CÂU 18: Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần thi) --
SELECT
	HocVien.*, Diem AS DIEMCAONHAT
FROM
	HocVien, KetQuaThi, MonHoc
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND KetQuaThi.MaMH = MonHoc.MaMH
	AND TenMH = N'CƠ SỞ DỮ LIỆU'
	AND Diem = 
	(
		SELECT MAX(Diem) 
		FROM KetQuaThi, MonHoc
		WHERE
			KetQuaThi.MaMH = MonHoc.MaMH
			AND MaHV = HocVien.MaHV
			AND TenMH = N'CƠ SỞ DỮ LIỆU'
		GROUP BY MaHV		--gom theo ma học viên--
	)
---------------------BUỔI 4--------------
use uit_qlgv
--Câu 19:Khoa nào (mã khoa, tên khoa) được thành lập sớm nhất--

SELECT MAKHOA, TENKHOA
FROM KHOA
WHERE NGTLAP= (
				SELECT MIN(NGTLAP)
				FROM KHOA
			  )

--Câu 20:Có bao nhiêu giáo viên có học hàm là “GS” hoặc “PGS”--
SELECT HOCHAM, COUNT(MAGV) AS SOLUONG
FROM GIAOVIEN
WHERE HOCHAM = 'PGS' OR HOCHAM = 'GS'
GROUP BY HOCHAM 

--LÀM THÊM: Có bao nhiêu giảng viên chưa là GS, PGS
SELECT HOCHAM, COUNT(MAGV) AS SOLUONG
FROM GIAOVIEN
WHERE HOCHAM NOT IN ('PGS', 'GS')
GROUP BY HOCHAM

--LÀM THÊM: Có bao nhiêu giảng viên chưa có học hàm
SELECT COUNT(MAGV) AS SOLUONG
FROM GIAOVIEN
WHERE HOCHAM = 'NULL'

--CÂU 21:Thống kê có bao nhiêu giáo viên có học vị là “CN”, “KS”, “Ths”, “TS”, “PTS” trong mỗi khoa--
SELECT MAKHOA, HOCVI, COUNT(MAGV) AS SOLUONG
FROM GIAOVIEN
WHERE HOCVI IN ('CN', 'KS', 'THS', 'TS', 'PTS')
GROUP BY MAKHOA, HOCVI
ORDER BY MAKHOA ASC

SELECT TENKHOA, GIAOVIEN.MAKHOA, HOCVI, COUNT(MAGV) AS SOLUONG
FROM GIAOVIEN
INNER JOIN KHOA ON GIAOVIEN.MAKHOA = KHOA.MAKHOA
WHERE HOCVI IN ('CN', 'KS', 'THS', 'TS', 'PTS')
GROUP BY TENKHOA, GIAOVIEN.MAKHOA, HOCVI
ORDER BY TENKHOA ASC

--LÀM THÊM: Coi TS và PTS là giống nhau, thống kê lại
SELECT COUNT(HOCVI) AS TIENSI
FROM GIAOVIEN
WHERE HOCVI = 'PTS' OR HOCVI = 'TS'

--LÀM THÊM: Cập nhật PTS thanh TS, TS thanh TSKH
UPDATE GIAOVIEN
SET 
	HOCVI = 'TSKH'
WHERE 
	HOCVI ='TS'

UPDATE GIAOVIEN
SET 
	HOCVI = 'TS'
WHERE 
	HOCVI ='PTS'

--LÀM THÊM: “CN”: 15, “KS”:15, “Ths”:22, “TS”:30, “TSKH”:30, "PGS": 40, "GS": 60
--Tính tiêu chí tuyển sinh--

--Thưa thầy em không làm ra câu này--

--Câu 22: Mỗi môn học thống kê số lượng học viên theo kết quả (đạt và không đạt)--
SELECT MONHOC.MAMH, TENMH, KQUA, COUNT(MAHV) as SOLUONG
FROM KETQUATHI
	INNER JOIN MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH
GROUP BY MONHOC.MAMH, TENMH, KQUA
ORDER BY TENMH

--Câu 23:Tìm giáo viên (mã giáo viên, họ tên) là giáo viên chủ nhiệm của một lớp, đồng thời dạy cho
--lớp đó ít nhất một môn học--
--C1:
SELECT DISTINCT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
	INNER JOIN LOP ON GIAOVIEN.MAGV = LOP.MAGVCN
	INNER JOIN GIANGDAY ON LOP.MALOP = GIANGDAY.MALOP

--C2:
SELECT DISTINCT
	GIAOVIEN.MAGV, HOTEN
FROM
	GIAOVIEN, LOP, GIANGDAY
WHERE
	GIANGDAY.MALOP = LOP.MALOP
	AND GIANGDAY.MAGV = GIAOVIEN.MAGV
	AND GIAOVIEN.MAGV = LOP.MAGVCN

--Câu 24:Tìm họ tên lớp trưởng của lớp có sỉ số cao nhất
SELECT CONCAT(HO,' ', TEN) AS HOTEN
FROM HOCVIEN
WHERE MAHV IN ( SELECT TRGLOP
				FROM LOP
				WHERE SISO = (SELECT MAX(SISO) FROM LOP)
			)

--Câu 25:* Tìm họ tên những LOPTRG thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả các lần thi)--
--C1
SELECT MAHV, CONCAT(HO,' ', TEN) AS HOTEN
FROM HOCVIEN
WHERE MAHV IN ( SELECT TRGLOP FROM LOP
				INNER JOIN KETQUATHI ON LOP.TRGLOP = KETQUATHI.MAHV
				WHERE DIEM < 5
				GROUP BY TRGLOP
				HAVING COUNT(MAHV) >=3
			)
--C2:
SELECT  HOCVIEN.MAHV, CONCAT(HO,' ', TEN) AS HOTEN
FROM
	HOCVIEN, LOP, KETQUATHI
WHERE
	HOCVIEN.MAHV = LOP.TRGLOP
	AND HOCVIEN.MAHV = KETQUATHI.MAHV
	AND KQUA = 'KHONG DAT'
GROUP BY 
	HOCVIEN.MAHV, TRGLOP, HO, TEN
HAVING 
	COUNT(*) > 3
--LÀM THÊM: Tìm họ tên những học viên thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả các lần thi)--

SELECT *
FROM HOCVIEN
WHERE MAHV IN (
				SELECT MAHV
				FROM ( SELECT MAHV, COUNT(MAHV) AS SOLUONG
						FROM (
								SELECT MAHV, MAMH
								FROM KETQUATHI
								WHERE KQUA = 'KHONG DAT'
								EXCEPT
								SELECT MAHV, MAMH
								FROM KETQUATHI
								WHERE KQUA = 'DAT' AND LANTHI > =2) AS T
						GROUP BY MAHV
						HAVING COUNT(MAHV) <=3 ) AS T2
				)

--Câu 26: Tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất--
--C1:
SELECT HOCVIEN.MAHV, CONCAT(HO,' ', TEN) AS HOTEN 
FROM HOCVIEN, KETQUATHI			
WHERE		HOCVIEN.MAHV = KETQUATHI.MAHV
			AND DIEM >= 9.00
			GROUP BY HOCVIEN.MAHV, HO, TEN
			HAVING COUNT(DIEM) =
			( SELECT MAX(SOLUONG)
			  FROM (SELECT MAHV, COUNT(DIEM) AS SOLUONG
					FROM KETQUATHI
					GROUP BY MAHV
					) AS T
				)
--C2:
SELECT TOP 1 WITH TIES 
	HOCVIEN.MAHV, CONCAT(Ho,' ',Ten) AS HOTEN
FROM 
	HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MaHV = KETQUATHI.MaHV
	AND DIEM >= 9
GROUP BY 
	HOCVIEN.MAHV, HO, TEn
ORDER BY 
	COUNT(*) DESC

--Câu 27: Trong từng lớp, tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất--
--C1:
SELECT HOCVIEN.MAHV, CONCAT(HO,' ', TEN) AS HOTEN,  LOP.MALOP
FROM KETQUATHI
INNER JOIN HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
INNER JOIN LOP ON HOCVIEN.MALOP = LOP.MALOP
WHERE		DIEM = 9.00 OR DIEM = 10.00
			GROUP BY HOCVIEN.MAHV, HO, TEN, LOP.MALOP

--C2:
SELECT
	MALOP, MAHV, HOTEN
FROM
(
	SELECT
		MALOP, HOCVIEN.MAHV, (Ho+' '+Ten) HOTEN, COUNT(*) SoLuongDiem, RANK() OVER (PARTITION BY MALOP ORDER BY COUNT(*) DESC) AS XepHang
	FROM
		HOCVIEN, KETQUATHI
	WHERE
		HOCVIEN.MAHV = KETQUATHI.MAHV
		AND Diem >= 9
	GROUP BY
		MALOP, HOCVIEN.MAHV, HO, TEN
) AS A
WHERE
	A.XepHang = 1

--Câu 28: Trong từng học kỳ của từng năm, mỗi giáo viên phân công dạy bao nhiêu môn học, bao nhiêu lớp--
SELECT  HOTEN, COUNT(MAMH) AS SOMON, COUNT( DISTINCT MALOP) AS SOLOP
FROM GIANGDAY
INNER JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
GROUP BY HOCKY, GIANGDAY.MAGV, HOTEN

--Câu 29: Trong từng học kỳ của từng năm, tìm giáo viên (mã giáo viên, họ tên) giảng dạy nhiều nhất--
SELECT HOTEN, GIAOVIEN.MAGV, NAM, HOCKY
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV
GROUP BY GIAOVIEN.MAGV, HOTEN, NAM, HOCKY
HAVING COUNT(MAMH) IN (
						SELECT MAX(SOLUONG)
						FROM (
							SELECT COUNT(MAMH) AS SOLUONG
							FROM GIANGDAY
							GROUP BY GIANGDAY.MAGV, HOCKY) AS TONG)


--Câu 30: Tìm môn học (mã môn học, tên môn học) có nhiều học viên thi không đạt (ở lần thi thứ 1)--
SELECT MONHOC.MAMH, TENMH, COUNT(KQUA) AS KETQUA
FROM MONHOC, KETQUATHI
WHERE MONHOC.MAMH = KETQUATHI.MAMH 
	  AND KQUA = 'KHONG DAT' AND LANTHI = 1 
GROUP BY MONHOC.MAMH, TENMH
HAVING COUNT(KQUA) IN 
( SELECT MAX(SOLUONG)
	FROM ( SELECT COUNT(KQUA) AS SOLUONG
			FROM KETQUATHI
			WHERE KQUA = 'KHONG DAT' AND LANTHI = 1
			GROUP BY MAMH) AS TONG		
		)

--Câu 31: Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi thứ 1)--
SELECT DISTINCT HOCVIEN.MAHV, CONCAT(HO, ' ', TEN) AS HOTEN
FROM KETQUATHI, HOCVIEN
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
	  AND NOT EXISTS
	  ( SELECT MAHV
		FROM KETQUATHI
		WHERE LANTHI = 1
		AND KQUA = 'KHONG DAT'
		AND MaHV = HOCVIEN.MAHV
		)

--Câu 32: * Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi sau cùng)--
SELECT DISTINCT
	HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS HOTEN
FROM
	HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KETQUATHI
		WHERE LANTHI = (SELECT MAX(LANTHI) FROM KETQUATHI
 WHERE MAHV = HOCVIEN.MAHV GROUP BY MAHV)
		AND KQUA = 'KHONG DAT'
		AND MAHV = HOCVIEN.MAHV
	)
--Câu 33: * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi thứ 1)--
SELECT MaHV, CONCAT(HO,' ',TEN) AS HOTEN
FROM HOCVIEN
WHERE NOT EXISTS
(
	SELECT *
	FROM MONHOC
	WHERE NOT EXISTS
	(
		SELECT *
		FROM KETQUATHI
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND KETQUATHI.MAHV = HOCVIEN.MAHV
			AND LANTHI = 1 AND KQUA = 'DAT'
	)
)

--Câu 34: * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi sau cùng)--
SELECT DISTINCT
	HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS HOTEN
FROM
	HOCVIEN, KETQUATHI, MONHOC
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV AND KETQUATHI.MAMH = MONHOC.MAMH
	AND LANTHI = (SELECT MAX(LANTHI) FROM KETQUATHI
				  WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND KETQUATHI.MAMH = MONHOC.MAMH
				  AND KQUA = 'DAT') 
GROUP BY HO, TEN, HOCVIEN.MAHV
HAVING COUNT(MONHOC.MAMH) = ( SELECT COUNT(MAMH) FROM MONHOC)

--Câu 35: ** Tìm học viên (mã học viên, họ tên) có điểm thi cao nhất trong từng môn (lấy điểm ở lần thi sau cùng)--

SELECT DISTINCT KETQUATHI.MAMH, HOCVIEN.MAHV, CONCAT(Ho,' ',Ten) AS HoTen, DIEM
FROM
	HOCVIEN, KETQUATHI, MONHOC
WHERE 
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND KETQUATHI.MAMH = MONHOC.MAMH
AND LANTHI = (SELECT MAX(LANTHI) FROM KETQUATHI WHERE MAHV = HOCVIEN.MAHV GROUP BY MAHV)
	AND DIEM IN (SELECT MAX(KETQUATHI.DIEM) FROM KETQUATHI GROUP BY KETQUATHI.MAMH)

-------------------------------------BUỔI 5-----------------------------------------
use uit_qlgv
--Câu 5: Kết quả thi là “Dat” nếu điểm từ 5 đến 10 và “Khong dat” nếu điểm nhỏ hơn 5 --
--INPUT: BẢNG KETQUATHI
ALTER TABLE KETQUATHI
ADD CONSTRAINT CHK_KQUA CHECK
((KQUA = 'DAT' AND DIEM BETWEEN 5 AND 10 )
OR ( KQUA = 'KHONG DAT' AND DIEM < 5))
select *
FROM KETQUATHI
--Câu 6: Học viên thi một môn tối đa 3 lần--
--INPUT: BANG HOCVIEN
ALTER TABLE KETQUATHI
ADD CONSTRAINT CHECK_LANTHI CHECK ( LANTHI <= 3)

--Câu 7: Học kỳ chỉ có giá trị từ 1 đến 3 --
--
ALTER TABLE GIANGDAY
ADD CONSTRAINT CHECK_HOCKY CHECK ( HOCKY BETWEEN 1 AND 3)

--Câu 8: Học vị của giáo viên chỉ có thể là “CN”, “KS”, “Ths”, ”TS”, ”TSKH” --
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CHECK_Hocvi CHECK ( HOCVI IN ('CN', 'KS', 'THS', 'TS', 'PTS'))

--Câu 9: Lớp trưởng của một lớp phải là học viên của lớp đó --
--Bảng: hocvien
CREATE TRIGGER TRG_LOP_LOPTRUONG
ON LOP
FOR INSERT
AS BEGIN
	DECLARE @TRGLOP char(5), @MALOP char(3), @MAHV char(5)
	SELECT @TRGLOP = TRGLOP, @MALOP = MALOP
	FROM inserted

	SELECT @MAHV = MAHV
	FROM HOCVIEN
	WHERE MAHV = @TRGLOP AND MALOP = @MALOP

	IF (@MAHV <> @TRGLOP)
		BEGIN
			PRINT 'XẢY RA LỖI'
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT 'ĐÚNG'
END


--thêm update
--Câu 10:Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”--
CREATE TRIGGER GIAOVIEN_KHOA_HOCVI
ON KHOA
FOR INSERT
AS BEGIN
	DECLARE @MAGV CHAR(4), @MAKHOA VARCHAR(4), @HOCVI VARCHAR(10), @TRGKHOA CHAR(4)
	SELECT @MAKHOA = MAKHOA, @TRGKHOA = TRGKHOA
	FROM inserted

	SELECT @MAGV = MAGV
	FROM GIAOVIEN
	WHERE MAGV = @TRGKHOA AND MAKHOA = @MAKHOA AND HOCVI IN ('TS', 'PTS')

	IF (@MAGV <> @TRGKHOA)
		BEGIN
			PRINT 'WRONG'
			ROLLBACK TRANSACTION
		END
	PRINT 'RIGHT'
END


--Câu 11: Học viên ít nhất là 18 tuổi--
ALTER TABLE HOCVIEN
ADD CONSTRAINT CHECK_TUOI CHECK ( YEAR(GETDATE()) - YEAR(NGSINH) >= 18)

--Câu 12:Giảng dạy một môn học ngày bắt đầu (TUNGAY) phải nhỏ hơn ngày kết thúc (DENNGAY).
--Xem thêm về các phép trừ thời gian
ALTER TABLE GIANGDAY
ADD CONSTRAINT CHECH_THOIGIAN CHECK ( TUNGAY < DENNGAY)

--Câu 13: Giáo viên khi vào làm ít nhất là 22 tuổi--
-- Bảng: Giáo viên
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CHECK_TUOIGV CHECK ( YEAR(NGVL) - YEAR(NGAYSINH) >= 22)

--Câu 14: Tất cả các môn học đều có số tín chỉ lý thuyết và tín chỉ thực hành chênh lệch nhau không quá 3--
--Bảng: môn học
UPDATE MONHOC
SET TCLT = 3, TCTH = 1
WHERE MAMH = 'HDH'

UPDATE MONHOC
SET TCLT = 3
WHERE MAMH = 'CTRR'

ALTER TABLE MONHOC
ADD CONSTRAINT CHECK_TINCHI CHECK ( ABS(TCLT - TCTH) <=3)

--Câu 15: Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.
CREATE TRIGGER HOCVIEN_THI
ON KETQUATHI
FOR INSERT, UPDATE
AS BEGIN
	DECLARE @MAHV CHAR(5), @MAMH VARCHAR(10), @MALOP CHAR(3)
	SELECT 

--Câu 16: Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.
CREATE TRIGGER HOCTAP_MOIKY
ON GIANGDAY
FOR INSERT, UPDATE
AS
BEGIN
	IF(SELECT COUNT(*)
	FROM INSERTED I JOIN GIANGDAY GD
	ON I.MALOP=GD.MALOP AND I.HOCKY=GD.HOCKY AND I.NAM = GD.NAM
	GROUP BY I.MALOP)>3
	BEGIN
		PRINT N'Mỗi học kỳ của một năm học - một lớp chỉ được học tối đa 3 môn.'
		ROLLBACK TRAN
	END
	ELSE
		BEGIN
		PRINT N'THÀNH CÔNG'
	END
END

--Câu 17: Sỉ số của một lớp bằng với số lượng học viên thuộc lớp đó.
CREATE TRIGGER SISO_HOCVIEN
ON LOP
FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @SISO TINYINT, @MALOP CHAR(3)

	SELECT @SISO = SISO , @MALOP = MALOP
	FROM inserted

	IF ( @SISO <> ( SELECT COUNT(MAHV)
				    FROM HOCVIEN HV
				    WHERE HV.MALOP  = @MALOP ) )
	   BEGIN
	         PRINT N'Sỉ số của một lớp = với số lượng học viên thuộc lớp đó.'
	         ROLLBACK TRANSACTION
	   END
	ELSE
	     PRINT 'Thành Công'
END

--Câu 18.: Trong quan hệ DIEUKIEN giá trị của thuộc tính MAMH và MAMH_TRUOC trong cùng
--một bộ không được giống nhau (“A”,”A”) và cũng không tồn tại hai bộ (“A”,”B”) và (“B”,”A”)--
CREATE TRIGGER DIEUKIEN_MONHOC
ON DIEUKIEN
FOR INSERT
AS 
BEGIN 

   DECLARE @bang TABLE( MAMH VARCHAR(10),
                        MAMH_TRUOC VARCHAR(10),
                        PRIMARY KEY(MAMH, MAMH_TRUOC))


   INSERT INTO @bang SELECT * FROM DIEUKIEN;
   UPDATE @bang SET MAMH = MAMH_TRUOC, MAMH_TRUOC = MAMH

   IF(SELECT count(*) AS SL FROM ( SELECT * 
                                   FROM @bang 
								  INTERSECT
								   SELECT *
								   FROM inserted) AS Q ) > 0

      BEGIN 
            PRINT N'Xảy ra lỗi'			
            ROLLBACK TRANSACTION
      END
            ELSE PRINT 'Thành Công'
END


--Câu 19: Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau--

CREATE TRIGGER GIAOVIEN_HOCVI
ON GIAOVIEN
FOR INSERT, UPDATE
AS
BEGIN
     DECLARE @SLGV TINYINT
	  
	 SELECT @SLGV = count(*)
	 FROM ( SELECT count(*) AS SL_ML
			FROM ( ( SELECT count(MAGV) AS SL, MUCLUONG
			         FROM GIAOVIEN
				     WHERE concat(HOCVI, HOCHAM, HESO, MUCLUONG) in ( SELECT concat(HOCVI, HOCHAM, HESO, AVG(MUCLUONG) ) 
                                                                      FROM GIAOVIEN 
																	  WHERE concat(HOCVI, HOCHAM, HESO) IN ( SELECT concat (HOCVI, HOCHAM, HESO) 
												                                                             FROM GIAOVIEN
																										   	 GROUP BY HOCVI, HOCHAM, HESO
																											 HAVING COUNT(concat(HOCVI, HOCHAM, HESO)) > 1 )
														                    and HOCVI <> 'NULL' AND HOCHAM <> 'NULL'
												                      GROUP BY HOCVI, HOCHAM, HESO ) 
				     GROUP BY MUCLUONG )

			       UNION ALL

			       ( SELECT count(MAGV) AS SL, MUCLUONG
			         FROM GIAOVIEN
					 WHERE concat(HOCVI, HOCHAM, HESO) IN ( SELECT concat(HOCVI, HOCHAM, HESO) 
                                                            FROM GIAOVIEN
															GROUP BY HOCVI, HOCHAM, HESO
															HAVING COUNT(concat(HOCVI, HOCHAM, HESO)) > 1 )
	                       and HOCVI <> 'NULL' AND HOCHAM <> 'NULL'
			         GROUP BY MUCLUONG, HOCVI, HOCHAM, HESO ) ) DATA
					 GROUP BY SL, MUCLUONG
					 HAVING COUNT(*) != 2 ) DATA

     IF (@SLGV > 0 ) BEGIN 
                           PRINT N'Xảy ra lỗi'
                           ROLLBACK TRANSACTION
                     END
     ELSE PRINT N'Thành công'
END

--Câu 20: Học viên chỉ được thi lại (lần thi >1) khi điểm của lần thi trước đó dưới 5--
CREATE TRIGGER HOCVIEN_THILAI ON KETQUATHI
FOR INSERT, UPDATE
AS 
BEGIN 
	  DECLARE @LANTHI TINYINT, @MAHV CHAR(5), @DIEM NUMERIC(4,2), @MAMH CHAR(10),@LANTHI2 TINYINT
	  SELECT @LANTHI = LANTHI, @MAHV = MAHV, @DIEM = DIEM, @MAMH = MAMH
	  FROM INSERTED

	  SELECT @LANTHI2 = LANTHI  FROM KETQUATHI
	  WHERE MAHV = @MAHV AND MAMH =@MAMH
	  IF((@LANTHI = @LANTHI2+1) AND @DIEM >5)
	  BEGIN
		   PRINT N'Học viên chỉ được thi lại khi điểm của lần thi trước đó dưới 5.'
		   ROLLBACK TRANSACTION
	  END
	  ELSE
	  PRINT N'Thànnh công'
END

--Câu 21: Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước (cùng học viên, cùng môn học)--
CREATE TRIGGER NGAYTHILAI_NGAYTHITRUOC ON KETQUATHI
FOR INSERT, UPDATE
AS 
BEGIN 
	  DECLARE @LANTHI TINYINT, @MAHV CHAR(5), @DIEM NUMERIC(4,2), @MAMH CHAR(10), @LANTHI2 TINYINT, @NGATHI SMALLDATETIME, @NGATHI2 SMALLDATETIME
	  SELECT @LANTHI = LANTHI, @MAHV = MAHV, @DIEM = DIEM, @MAMH = MAMH
	  FROM INSERTED

	  SELECT @LANTHI2 = LANTHI, @NGATHI2 = NGATHI FROM KETQUATHI
	  WHERE MAHV = @MAHV AND MAMH =@MAMH
	  IF((@LANTHI = @LANTHI2+1) AND @NGATHI2 < @NGATHI)
	  BEGIN
		   PRINT N'Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước.'
		   ROLLBACK TRANSACTION
	  END
	  ELSE
	  PRINT N'Thànnh công'
END

--Câu 22: Học viên chỉ được thi những môn mà lớp của học viên đó đã học xong--
CREATE TRIGGER HOCVIEN_MONHOC ON KETQUATHI
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @MAMH CHAR(10), @MAHV CHAR(5), @NGKT SMALLDATETIME, @NGATHI SMALLDATETIME
	SELECT @MAMH = MAMH , @MAHV = MAHV, @NGATHI = NGATHI
	FROM INSERTED

	SELECT @NGKT = DENNGAY 
	FROM GIANGDAY
	WHERE MAMH = @MAMH
	IF(@NGATHI < @NGKT)
	BEGIN
	PRINT N'Học viên chỉ được thi những môn mà lớp của học viên đó đã học xong.'
	ROLLBACK TRANSACTION
	END
	ELSE
	PRINT 'THANH CONG'
END

--Câu 23: Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học (sau
--khi học xong những môn học phải học trước mới được học những môn liền sau)--
CREATE TRIGGER PHANCONG_GIANGDAY ON GIANGDAY
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @MAMH CHAR(10), @MALOP CHAR(3), @MAMH_TRUOC CHAR(10),@MAMH2 CHAR(10)
	SELECT @MAMH = MAMH, @MALOP = MALOP
	FROM INSERTED 

	SELECT @MAMH_TRUOC = MAMH_TRUOC 
	FROM DIEUKIEN
	WHERE MAMH = @MAMH

	SELECT @MAMH2 = MAMH FROM GIANGDAY
	WHERE MALOP = @MALOP 
	IF(@MAMH_TRUOC <>  @MAMH2 )
	BEGIN
	PRINT N'Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học'
	ROLLBACK TRANSACTION
	END
	ELSE
	PRINT 'THANH CONG'
END
--Câu 24: Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách--
CREATE TRIGGER PHANCONGDAY
ON GIANGDAY
FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @MAKHOA1 VARCHAR(4), @MAMH VARCHAR(10), @MAGV CHAR(4), @MAKHOA2 VARCHAR(4)
	SELECT @MAGV = MAGV, @MAMH = MAMH
	FROM inserted

	SELECT @MAKHOA1 = MAKHOA
	FROM GIAOVIEN
	WHERE MAGV = @MAGV

	SELECT @MAKHOA2 = MAKHOA
	FROM MONHOC
	WHERE MAMH = @MAMH

	IF( @MAKHOA2 <> @MAKHOA1)
		BEGIN
			PRINT N'LỖI!'
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT N'THÀNH CÔNG'
END
